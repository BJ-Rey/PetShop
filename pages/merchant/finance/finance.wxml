<!-- pages/merchant/finance/finance.wxml -->
<view class="container">
  <!-- é¡¶éƒ¨æ“ä½œæ  -->
  <view class="standard-action-bar">
    <text class="standard-back-btn" bindtap="navigateBack">â†</text>
    <text class="page-title">è´¢åŠ¡ç®¡ç†</text>
    <button class="logout-btn" bindtap="logout">é€€å‡ºç™»å½•</button>
  </view>

  <!-- è´¢åŠ¡æ¦‚è§ˆ -->
  <view class="finance-overview">
    <view class="overview-card">
      <text class="overview-title">ä»Šæ—¥æ”¶å…¥</text>
      <text class="overview-value">Â¥{{todayIncome}}</text>
      <text class="overview-change {{todayIncomeChange >= 0 ? 'positive' : 'negative'}}">
        {{todayIncomeChange >= 0 ? '+' : ''}}{{todayIncomeChange}}%
      </text>
    </view>
    
    <view class="overview-card">
      <text class="overview-title">æœ¬æœˆæ”¶å…¥</text>
      <text class="overview-value">Â¥{{monthIncome}}</text>
      <text class="overview-change {{monthIncomeChange >= 0 ? 'positive' : 'negative'}}">
        {{monthIncomeChange >= 0 ? '+' : ''}}{{monthIncomeChange}}%
      </text>
    </view>
    
    <view class="overview-card">
      <text class="overview-title">ç´¯è®¡æ”¶å…¥</text>
      <text class="overview-value">Â¥{{totalIncome}}</text>
      <text class="overview-change {{totalIncomeChange >= 0 ? 'positive' : 'negative'}}">
        {{totalIncomeChange >= 0 ? '+' : ''}}{{totalIncomeChange}}%
      </text>
    </view>
    
    <view class="overview-card">
      <text class="overview-title">å¾…ç»“ç®—é‡‘é¢</text>
      <text class="overview-value">Â¥{{pendingSettlement}}</text>
      <text class="overview-desc">é¢„è®¡1-3ä¸ªå·¥ä½œæ—¥åˆ°è´¦</text>
    </view>
  </view>

  <!-- é”€é‡æ•°æ®å¯è§†åŒ– -->
  <view class="chart-section card">
    <view class="section-header">
      <text class="section-title">é”€é‡æ•°æ®å¯è§†åŒ–</text>
      <view class="chart-actions">
        <button class="export-btn" bindtap="exportData">å¯¼å‡ºæ•°æ®</button>
        <button class="refresh-btn" bindtap="refreshData">åˆ·æ–°</button>
      </view>
    </view>
    
    <!-- æ—¶é—´ç»´åº¦åˆ‡æ¢ -->
    <view class="time-dimension">
      <text 
        class="dimension-item {{timeDimension === 'day' ? 'active' : ''}}" 
        bindtap="changeTimeDimension" 
        data-dimension="day"
      >
        æ—¥
      </text>
      <text 
        class="dimension-item {{timeDimension === 'week' ? 'active' : ''}}" 
        bindtap="changeTimeDimension" 
        data-dimension="week"
      >
        å‘¨
      </text>
      <text 
        class="dimension-item {{timeDimension === 'month' ? 'active' : ''}}" 
        bindtap="changeTimeDimension" 
        data-dimension="month"
      >
        æœˆ
      </text>
      <text 
        class="dimension-item {{timeDimension === 'quarter' ? 'active' : ''}}" 
        bindtap="changeTimeDimension" 
        data-dimension="quarter"
      >
        å­£åº¦
      </text>
      <text 
        class="dimension-item {{timeDimension === 'year' ? 'active' : ''}}" 
        bindtap="changeTimeDimension" 
        data-dimension="year"
      >
        å¹´
      </text>
    </view>
  </view>
  
  <!-- é”€é‡è¶‹åŠ¿å›¾ -->
  <view class="chart-section card">
    <view class="section-header">
      <text class="section-title">é”€é‡è¶‹åŠ¿</text>
    </view>
    <canvas 
      canvas-id="salesTrendChart" 
      class="sales-trend-chart" 
      bindtouchstart="onChartTouchStart"
      bindtouchmove="onChartTouchMove"
      bindtouchend="onChartTouchEnd"
    ></canvas>
    
    <!-- åŒæ¯”/ç¯æ¯”å¢é•¿ç‡ -->
    <view class="growth-rate">
      <view class="rate-item">
        <text class="rate-label">åŒæ¯”å¢é•¿ç‡:</text>
        <text class="rate-value {{yearOnYearGrowth >= 0 ? 'positive' : 'negative'}}">
          {{yearOnYearGrowth >= 0 ? '+' : ''}}{{yearOnYearGrowth}}%
        </text>
      </view>
      <view class="rate-item">
        <text class="rate-label">ç¯æ¯”å¢é•¿ç‡:</text>
        <text class="rate-value {{monthOnMonthGrowth >= 0 ? 'positive' : 'negative'}}">
          {{monthOnMonthGrowth >= 0 ? '+' : ''}}{{monthOnMonthGrowth}}%
        </text>
      </view>
    </view>
  </view>
  
  <!-- ä¸šåŠ¡çº¿é”€é‡å æ¯” -->
  <view class="chart-section card">
    <view class="section-header">
      <text class="section-title">ä¸šåŠ¡çº¿é”€é‡å æ¯”</text>
    </view>
    <canvas 
      canvas-id="businessLineChart" 
      class="business-line-chart"
    ></canvas>
    
    <!-- ä¸šåŠ¡çº¿å›¾ä¾‹ -->
    <view class="legend">
      <view class="legend-item" wx:for="{{businessLines}}" wx:key="id">
        <view class="legend-color" style="background-color: {{item.color}}"></view>
        <text class="legend-name">{{item.name}}</text>
        <text class="legend-value">Â¥{{item.sales}}</text>
        <text class="legend-percentage">({{item.percentage}}%)</text>
      </view>
    </view>
  </view>
  
  <!-- å¼‚å¸¸æ•°æ®é¢„è­¦ -->
  <view class="alert-section card" wx:if="hasAlerts">
    <view class="section-header">
      <text class="section-title">å¼‚å¸¸æ•°æ®é¢„è­¦</text>
    </view>
    <view class="alert-list">
      <view class="alert-item" wx:for="{{alerts}}" wx:key="id">
        <view class="alert-icon" style="background-color: {{item.level === 'high' ? '#ff4d4f' : item.level === 'medium' ? '#faad14' : '#1890ff'}}"></view>
        <view class="alert-content">
          <text class="alert-title">{{item.title}}</text>
          <text class="alert-desc">{{item.description}}</text>
          <text class="alert-time">{{item.time}}</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- è‡ªå®šä¹‰æŸ¥è¯¢ -->
  <view class="custom-query-section card">
    <view class="section-header">
      <text class="section-title">è‡ªå®šä¹‰æŸ¥è¯¢</text>
    </view>
    <view class="query-form">
      <view class="form-row">
        <text class="form-label">å¼€å§‹æ—¥æœŸ:</text>
        <picker mode="date" value="{{startDate}}" bindchange="onStartDateChange">
          <view class="picker">
            {{startDate}}
          </view>
        </picker>
      </view>
      <view class="form-row">
        <text class="form-label">ç»“æŸæ—¥æœŸ:</text>
        <picker mode="date" value="{{endDate}}" bindchange="onEndDateChange">
          <view class="picker">
            {{endDate}}
          </view>
        </picker>
      </view>
      <view class="form-row">
        <text class="form-label">ä¸šåŠ¡çº¿:</text>
        <picker mode="multiSelector" range="{{businessLineOptions}}" value="{{businessLineIndex}}" bindchange="onBusinessLineChange">
          <view class="picker">
            {{selectedBusinessLines.length > 0 ? selectedBusinessLines.join(', ') : 'å…¨éƒ¨'}}
          </view>
        </picker>
      </view>
      <button class="query-btn" bindtap="executeQuery">æ‰§è¡ŒæŸ¥è¯¢</button>
    </view>
  </view>

  <!-- äº¤æ˜“æ˜ç»† -->
  <view class="transaction-section card">
    <view class="section-header">
      <text class="section-title">äº¤æ˜“æ˜ç»†</text>
      <button class="view-all-btn" bindtap="viewAllTransactions">æŸ¥çœ‹å…¨éƒ¨</button>
    </view>
    
    <view class="transaction-list">
      <view class="empty-state" wx:if="{{!isLoading && transactions.length === 0}}">
        <text class="empty-icon">ğŸ’¸</text>
        <text class="empty-text">æš‚æ— äº¤æ˜“è®°å½•</text>
      </view>
      
      <view class="loading-state" wx:if="{{isLoading}}">
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>
      
      <block wx:else>
        <view class="transaction-item" wx:for="{{transactions}}" wx:key="id">
          <view class="transaction-info">
            <text class="transaction-type {{item.type === 'income' ? 'income' : 'expense'}}">
              {{item.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}}
            </text>
            <text class="transaction-desc">{{item.description}}</text>
            <text class="transaction-time">{{item.createdAt.split('T')[0]}}</text>
          </view>
          <text class="transaction-amount {{item.type === 'income' ? 'income' : 'expense'}}">
            {{item.type === 'income' ? '+' : '-'}}Â¥{{item.amount}}
          </text>
        </view>
      </block>
    </view>
  </view>

  <!-- ç»“ç®—è®°å½• -->
  <view class="settlement-section card">
    <view class="section-header">
      <text class="section-title">ç»“ç®—è®°å½•</text>
      <button class="view-all-btn" bindtap="viewAllSettlements">æŸ¥çœ‹å…¨éƒ¨</button>
    </view>
    
    <view class="settlement-list">
      <view class="empty-state" wx:if="{{!isLoading && settlements.length === 0}}">
        <text class="empty-icon">ğŸ’°</text>
        <text class="empty-text">æš‚æ— ç»“ç®—è®°å½•</text>
      </view>
      
      <view class="loading-state" wx:if="{{isLoading}}">
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>
      
      <block wx:else>
        <view class="settlement-item" wx:for="{{settlements}}" wx:key="id">
          <view class="settlement-info">
            <text class="settlement-period">{{item.periodStart}} - {{item.periodEnd}}</text>
            <text class="settlement-status {{item.status}}">
              {{item.status === 'completed' ? 'å·²å®Œæˆ' : item.status === 'processing' ? 'å¤„ç†ä¸­' : 'å¾…å¤„ç†'}}
            </text>
            <text class="settlement-time">ç»“ç®—æ—¶é—´ï¼š{{item.settlementTime ? item.settlementTime.split('T')[0] : 'æœªç»“ç®—'}}</text>
          </view>
          <text class="settlement-amount">Â¥{{item.amount}}</text>
        </view>
      </block>
    </view>
  </view>
</view>
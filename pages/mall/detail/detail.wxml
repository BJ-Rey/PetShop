<!--pages/mall/detail/detail.wxml-->
<wxs module="utils">
  var getDiscount = function(price, originalPrice) {
    if (!originalPrice || originalPrice <= price) return '';
    var discount = Math.round((1 - price / originalPrice) * 100);
    return discount + '% 优惠';
  }
  module.exports = {
    getDiscount: getDiscount
  }
</wxs>

<view class="container">
  <auth-modal id="auth-modal" />
  <!-- 顶部操作栏 -->
  <view class="standard-action-bar custom-nav">
    <view class="nav-left" bindtap="navigateBack">
      <text class="standard-back-btn">←</text>
    </view>
    <text class="page-title">{{product.name}}</text>
  </view>

  <!-- 商品图片轮播 -->
  <swiper wx:if="{{product.images && product.images.length > 0}}" indicator-dots="{{indicatorDots}}" autoplay="{{autoplay}}" interval="{{interval}}" duration="{{duration}}">
    <block wx:for="{{product.images}}" wx:key="index">
      <swiper-item>
        <image src="{{item}}" class="product-image" mode="aspectFill"></image>
      </swiper-item>
    </block>
  </swiper>

  <!-- 商品基本信息 -->
  <view class="product-info-section">
    <view class="price-section">
      <text class="current-price">¥{{product.price}}</text>
      <text class="original-price" wx:if="{{product.originalPrice > product.price}}">¥{{product.originalPrice}}</text>
      <text class="discount" wx:if="{{product.originalPrice > product.price}}">{{utils.getDiscount(product.price, product.originalPrice)}}</text>
    </view>
    
    <view class="info-header">
      <text class="product-name">{{product.name}}</text>
    </view>

    <view class="product-meta">
      <text class="product-rating">
        <text class="star">★</text>
        {{product.rating}}
      </text>
      <text class="product-sales">销量 {{product.sales}}</text>
      <text class="product-stock" wx:if="{{product.stock > 0}}">库存 {{product.stock}}</text>
      <text class="product-stock out-of-stock" wx:else>无库存</text>
    </view>
  </view>

  <!-- 商品详情 -->
  <view class="product-detail-section card">
    <view class="section-title">商品详情</view>
    <view class="product-description">{{product.description}}</view>
    <!-- 商品图片详情 -->
    <block wx:if="{{product.detailImages && product.detailImages.length > 0}}">
      <image wx:for="{{product.detailImages}}" wx:key="index" src="{{item}}" class="detail-image" mode="widthFix"></image>
    </block>
  </view>

  <!-- 商品规格选择 -->
  <view class="product-specs-section card">
    <view class="section-title">选择规格</view>
    <view class="specs-grid">
      <view class="spec-item" wx:for="{{product.specs}}" wx:key="id">
        <text class="spec-label">{{item.name}}:</text>
        <view class="spec-options">
          <view class="spec-option {{selectedSpecs[item.id] === option.value ? 'active' : ''}}" 
                wx:for="{{item.options}}" 
                wx:for-item="option" 
                wx:key="value"
                bindtap="selectSpec" 
                data-spec-id="{{item.id}}" 
                data-option-value="{{option.value}}">
            {{option.name}}
          </view>
        </view>
      </view>
    </view>
    <view class="quantity-control">
      <text class="quantity-label">数量:</text>
      <view class="quantity-input-group">
        <text class="quantity-decrease" bindtap="decreaseQuantity" wx:if="{{quantity > 1}}">-</text>
        <text class="quantity" wx:else>1</text>
        <text class="quantity-input">{{quantity}}</text>
        <text class="quantity-increase" bindtap="increaseQuantity" wx:if="{{quantity < product.stock}}">+</text>
      </view>
    </view>
  </view>

  <!-- 底部操作栏 -->
  <view class="bottom-bar">
    <view class="cart-icon" bindtap="navigateToCart">
      <view class="icon-wrapper">
        <image src="/images/商品_commodity.svg" mode="aspectFit" class="bar-icon"></image>
        <text class="badge" wx:if="{{cartCount > 0}}">{{cartCount}}</text>
      </view>
      <text class="bar-text">购物车</text>
    </view>
    <view class="btn-group">
      <button class="add-to-cart-btn" bindtap="addToCart">加入购物车</button>
      <button class="buy-now-btn" bindtap="showSpecModal">立即购买</button>
    </view>
  </view>

  <!-- 规格选择弹窗 -->
  <view class="spec-modal-mask" wx:if="{{showSpecModal}}" bindtap="hideSpecModal"></view>
  <view class="spec-modal {{showSpecModal ? 'show' : ''}}">
    <view class="spec-header">
      <image src="{{product.image}}" class="spec-thumb" mode="aspectFill"></image>
      <view class="spec-info">
        <text class="price">¥{{product.price}}</text>
        <text class="selected-spec">已选: {{selectedSpec || '请选择规格'}}</text>
      </view>
      <text class="close-btn" bindtap="hideSpecModal">×</text>
    </view>
    <scroll-view scroll-y="true" class="spec-content">
      <view class="spec-section">
        <text class="section-title">规格</text>
        <view class="spec-list">
          <text class="spec-item {{selectedSpec === item ? 'active' : ''}}" wx:for="{{product.specs}}" wx:key="*this" bindtap="selectSpec" data-spec="{{item}}">{{item}}</text>
        </view>
      </view>
      <view class="quantity-section">
        <text class="section-title">数量</text>
        <view class="quantity-control">
          <text class="minus {{quantity <= 1 ? 'disabled' : ''}}" bindtap="decreaseQuantity">-</text>
          <input type="number" value="{{quantity}}" disabled />
          <text class="plus" bindtap="increaseQuantity">+</text>
        </view>
      </view>
    </scroll-view>
    <button class="confirm-btn" bindtap="confirmBuy">确认下单</button>
  </view>
</view>

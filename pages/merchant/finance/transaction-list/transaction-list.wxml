<!-- pages/merchant/finance/transaction-list/transaction-list.wxml -->
<wxs module="utils">
  module.exports.formatDate = function(dateString) {
    if (!dateString) return '';
    var date = getDate(dateString);
    var year = date.getFullYear();
    var month = date.getMonth() + 1;
    var day = date.getDate();
    var hour = date.getHours();
    var minute = date.getMinutes();
    
    if (month < 10) month = '0' + month;
    if (day < 10) day = '0' + day;
    if (hour < 10) hour = '0' + hour;
    if (minute < 10) minute = '0' + minute;
    
    return year + '-' + month + '-' + day + ' ' + hour + ':' + minute;
  }
</wxs>

<view class="container">
  <!-- é¡¶éƒ¨æ“ä½œæ  -->
  <view class="standard-action-bar">
    <text class="standard-back-btn" bindtap="navigateBack">â†</text>
    <text class="page-title">äº¤æ˜“æ˜ç»†</text>
    <button class="logout-btn" bindtap="logout">é€€å‡ºç™»å½•</button>
  </view>

  <!-- æœç´¢å’Œç­›é€‰æ  -->
  <view class="search-filter-bar">
    <input 
      class="search-input" 
      placeholder="æœç´¢äº¤æ˜“æè¿°" 
      bindinput="onSearch" 
      value="{{filter.keyword}}"
    />
    <button class="filter-btn" bindtap="toggleFilterPanel">
      <text class="filter-icon">ğŸ”</text>
      <text class="filter-text">ç­›é€‰</text>
    </button>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view class="filter-panel" wx:if="{{showFilterPanel}}">
    <view class="filter-section">
      <text class="filter-title">äº¤æ˜“ç±»å‹</text>
      <view class="filter-options">
        <view 
          class="filter-option {{filter.type === 'all' ? 'active' : ''}}" 
          bindtap="changeFilter" 
          data-type="type"
          data-value="all"
        >
          å…¨éƒ¨
        </view>
        <view 
          class="filter-option {{filter.type === 'income' ? 'active' : ''}}" 
          bindtap="changeFilter" 
          data-type="type"
          data-value="income"
        >
          æ”¶å…¥
        </view>
        <view 
          class="filter-option {{filter.type === 'expense' ? 'active' : ''}}" 
          bindtap="changeFilter" 
          data-type="type"
          data-value="expense"
        >
          æ”¯å‡º
        </view>
      </view>
    </view>
    
    <view class="filter-section">
      <text class="filter-title">æ—¶é—´èŒƒå›´</text>
      <view class="filter-options">
        <view 
          class="filter-option {{filter.timeRange === 'today' ? 'active' : ''}}" 
          bindtap="changeFilter" 
          data-type="timeRange"
          data-value="today"
        >
          ä»Šå¤©
        </view>
        <view 
          class="filter-option {{filter.timeRange === 'week' ? 'active' : ''}}" 
          bindtap="changeFilter" 
          data-type="timeRange"
          data-value="week"
        >
          æœ¬å‘¨
        </view>
        <view 
          class="filter-option {{filter.timeRange === 'month' ? 'active' : ''}}" 
          bindtap="changeFilter" 
          data-type="timeRange"
          data-value="month"
        >
          æœ¬æœˆ
        </view>
        <view 
          class="filter-option {{filter.timeRange === 'quarter' ? 'active' : ''}}" 
          bindtap="changeFilter" 
          data-type="timeRange"
          data-value="quarter"
        >
          æœ¬å­£åº¦
        </view>
      </view>
    </view>
    
    <view class="filter-section">
      <text class="filter-title">äº¤æ˜“çŠ¶æ€</text>
      <view class="filter-options">
        <view 
          class="filter-option {{filter.status === 'all' ? 'active' : ''}}" 
          bindtap="changeFilter" 
          data-type="status"
          data-value="all"
        >
          å…¨éƒ¨
        </view>
        <view 
          class="filter-option {{filter.status === 'completed' ? 'active' : ''}}" 
          bindtap="changeFilter" 
          data-type="status"
          data-value="completed"
        >
          å·²å®Œæˆ
        </view>
        <view 
          class="filter-option {{filter.status === 'processing' ? 'active' : ''}}" 
          bindtap="changeFilter" 
          data-type="status"
          data-value="processing"
        >
          å¤„ç†ä¸­
        </view>
        <view 
          class="filter-option {{filter.status === 'failed' ? 'active' : ''}}" 
          bindtap="changeFilter" 
          data-type="status"
          data-value="failed"
        >
          å¤±è´¥
        </view>
      </view>
    </view>
    
    <view class="filter-actions">
      <button class="reset-btn" bindtap="resetFilter">é‡ç½®</button>
      <button class="confirm-btn" type="primary" bindtap="applyFilter">ç¡®è®¤</button>
    </view>
  </view>

  <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
  <view class="stats-section">
    <view class="stat-item">
      <text class="stat-label">æ€»ç¬”æ•°</text>
      <text class="stat-value">{{stats.totalCount}}</text>
    </view>
    <view class="stat-item">
      <text class="stat-label">æ€»æ”¶å…¥</text>
      <text class="stat-value income">+Â¥{{stats.totalIncome}}</text>
    </view>
    <view class="stat-item">
      <text class="stat-label">æ€»æ”¯å‡º</text>
      <text class="stat-value expense">-Â¥{{stats.totalExpense}}</text>
    </view>
    <view class="stat-item">
      <text class="stat-label">å‡€æ”¶å…¥</text>
      <text class="stat-value {{stats.netIncome >= 0 ? 'income' : 'expense'}}">
        {{stats.netIncome >= 0 ? '+' : ''}}Â¥{{stats.netIncome}}
      </text>
    </view>
  </view>

  <!-- æ’åºæ  -->
  <view class="sort-bar">
    <view 
      class="sort-item {{sortField === 'createdAt' ? 'active' : ''}}" 
      bindtap="changeSort" 
      data-field="createdAt"
    >
      <text>æ—¶é—´</text>
      <text class="sort-icon">{{sortField === 'createdAt' ? (sortOrder === 'desc' ? 'â†“' : 'â†‘') : ''}}</text>
    </view>
    <view 
      class="sort-item {{sortField === 'amount' ? 'active' : ''}}" 
      bindtap="changeSort" 
      data-field="amount"
    >
      <text>é‡‘é¢</text>
      <text class="sort-icon">{{sortField === 'amount' ? (sortOrder === 'desc' ? 'â†“' : 'â†‘') : ''}}</text>
    </view>
  </view>

  <!-- äº¤æ˜“åˆ—è¡¨ -->
  <view class="transaction-list">
    <view class="empty-state" wx:if="{{!isLoading && transactions.length === 0}}">
      <text class="empty-icon">ğŸ’¸</text>
      <text class="empty-text">æš‚æ— äº¤æ˜“è®°å½•</text>
    </view>
    
    <view class="loading-state" wx:if="{{isLoading}}">
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
    
    <block wx:else>
      <view class="transaction-item card" wx:for="{{transactions}}" wx:key="id">
        <view class="transaction-header">
          <view class="transaction-type-badge {{item.type === 'income' ? 'income' : 'expense'}}">
            {{item.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}}
          </view>
          <view class="transaction-status-badge {{item.status}}">
            {{item.status === 'completed' ? 'å·²å®Œæˆ' : item.status === 'processing' ? 'å¤„ç†ä¸­' : 'å¤±è´¥'}}
          </view>
        </view>
        
        <view class="transaction-content">
          <text class="transaction-desc">{{item.description}}</text>
          <text class="transaction-amount {{item.type === 'income' ? 'income' : 'expense'}}">
            {{item.type === 'income' ? '+' : '-'}}Â¥{{item.amount}}
          </text>
        </view>
        
        <view class="transaction-footer">
          <text class="transaction-time">{{utils.formatDate(item.createdAt)}}</text>
          <button class="detail-btn" bindtap="viewTransactionDetail" data-id="{{item.id}}">
            è¯¦æƒ…
          </button>
        </view>
      </view>
    </block>
  </view>

  <!-- å¯¼å‡ºæŒ‰é’® -->
  <view class="export-section" wx:if="{{transactions.length > 0}}">
    <button class="export-btn" type="primary" bindtap="exportTransactions">å¯¼å‡ºäº¤æ˜“è®°å½•</button>
  </view>
</view>
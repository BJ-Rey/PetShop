<!--pet/detail/detail.wxml-->
<view class="container">
  <auth-modal id="auth-modal" />
  <global-cart wx:if="{{!isMerchant}}" />
  <!-- é¡¶éƒ¨æ“ä½œæ  -->
  <view class="custom-nav-placeholder" style="height: {{navBarTotalHeight}}px; background: #fff;"></view>
  <view class="custom-nav" style="height: {{navBarHeight}}px; padding-top: {{statusBarHeight}}px; padding-right: {{capsuleWidth + capsuleRight + 10}}px;">
    <view class="nav-left" bindtap="navigateBack">
      <text class="standard-back-btn">â†</text>
    </view>
    <text class="page-title">{{pet.name}}</text>
    <!-- åŠŸèƒ½æŒ‰é’®ç§»åˆ°æ ‡é¢˜æ å†…ï¼Œä½†éœ€è¦æ³¨æ„ç©ºé—´ -->
    <view class="action-buttons">
    </view>
  </view>

  <!-- å® ç‰©å°é¢å›¾è½®æ’­ -->
  <swiper indicator-dots="{{indicatorDots}}" autoplay="{{autoplay}}" interval="{{interval}}" duration="{{duration}}">
    <block wx:for="{{pet.images}}" wx:key="index">
      <swiper-item>
        <image src="{{item}}" class="product-image" mode="aspectFill"></image>
        <!-- å® ç‰©çŠ¶æ€æ ‡ç­¾ -->
        <pet-status-tag status="{{pet.status}}" statusText="{{pet.statusText}}" style="position: absolute; top: 30rpx; left: 30rpx; z-index: 10;"></pet-status-tag>
      </swiper-item>
    </block>
  </swiper>

  <!-- å® ç‰©åŸºæœ¬ä¿¡æ¯ -->
  <view class="product-info-section">
    <view class="price-section">
      <text class="current-price">Â¥{{pet.price}}</text>
      <text class="deposit-info">å®šé‡‘ï¼šÂ¥{{pet.deposit}}</text>
      <text class="balance-status" wx:if="{{pet.isOrdered}}">{{pet.balanceStatusText}}</text>
    </view>
    <text class="product-name">{{pet.name}}</text>
    <view class="product-meta">
      <text class="product-rating">
        <text class="star">â˜…</text>
        {{pet.rating || 0}}
      </text>
      <text class="product-sales">é”€é‡ {{pet.sales || 0}}</text>
    </view>
    <view class="pet-meta">
      <text class="meta-item">{{pet.breed}}</text>
      <text class="meta-item">{{pet.age}}</text>
      <text class="meta-item">{{pet.gender === 'male' ? 'å…¬' : 'æ¯'}}</text>
      <text class="meta-item">{{pet.color}}</text>
    </view>
    <view class="pet-stats">
      <view class="stat-item">
        <text class="label">æ€§æ ¼</text>
        <text class="value">{{pet.temperament || 'æ¸©é¡º'}}</text>
      </view>
      <view class="stat-item">
        <text class="label">ç–«è‹—</text>
        <text class="value">{{pet.vaccineStatus || 'é½å…¨'}}</text>
      </view>
      <view class="stat-item">
        <text class="label">é©±è™«</text>
        <text class="value">{{pet.wormingStatus || 'å·²åš'}}</text>
      </view>
    </view>
  </view>

  <!-- å® ç‰©è¯¦æƒ… -->
  <view class="product-detail-section card">
    <view class="section-title">å® ç‰©ç®€ä»‹</view>
    <view class="product-description" wx:if="{{pet.description}}">{{pet.description}}</view>
    <view class="product-description" wx:else>æš‚æ— ç®€ä»‹</view>
  </view>

  <!-- å¥åº·ä¿¡æ¯ -->
  <view class="product-detail-section card">
    <view class="section-title">å¥åº·ä¿¡æ¯</view>
    <view class="health-status">
      <text class="status-label">å¥åº·çŠ¶å†µ:</text>
      <text class="status-value {{pet.hasDisease ? 'unhealthy' : 'healthy'}}">
        {{pet.hasDisease ? 'æœ‰æš—ç—…' : 'å¥åº·'}}
      </text>
    </view>
    <view class="disease-info" wx:if="{{pet.hasDisease}}">
      <text class="disease-label">ç–¾ç—…ç±»å‹:</text>
      <text class="disease-value">{{pet.diseases.join('ã€')}}</text>
    </view>
    
    <!-- ç–«è‹—è®°å½• -->
    <view class="record-section" wx:if="{{pet.vaccineRecords && pet.vaccineRecords.length > 0}}">
      <view class="record-title">ç–«è‹—è®°å½•</view>
      <block wx:for="{{pet.vaccineRecords}}" wx:key="id">
        <view class="record-item">
          <view class="record-header">
            <text class="record-name">{{item.name}}</text>
            <text class="record-time">{{item.date}}</text>
          </view>
          <text class="record-institution">{{item.institution}}</text>
          <image src="{{item.certificate}}" class="record-certificate" wx:if="{{item.certificate}}"></image>
        </view>
      </block>
    </view>
    
    <!-- é©±è™«è®°å½• -->
    <view class="record-section" wx:if="{{pet.dewormingRecords && pet.dewormingRecords.length > 0}}">
      <view class="record-title">é©±è™«è®°å½•</view>
      <block wx:for="{{pet.dewormingRecords}}" wx:key="id">
        <view class="record-item">
          <view class="record-header">
            <text class="record-name">{{item.medicine}}</text>
            <text class="record-time">{{item.date}}</text>
          </view>
          <text class="record-institution">{{item.institution}}</text>
          <image src="{{item.certificate}}" class="record-certificate" wx:if="{{item.certificate}}"></image>
        </view>
      </block>
    </view>
  </view>

  <!-- äº²å±å…³ç³» -->
  <view class="product-detail-section card" wx:if="{{pet.relatives && pet.relatives.length > 0}}">
    <view class="section-title">
      <text>äº²å±å…³ç³»</text>
      <text class="add-relative" bindtap="addRelative" wx:if="{{isMyPet && isMerchant}}">æ·»åŠ äº²å±</text>
    </view>
    <block wx:for="{{pet.relatives}}" wx:key="id">
      <view class="relative-item" bindtap="navigateToRelativeDetail" data-id="{{item.id}}">
        <image src="{{item.avatar}}" class="relative-avatar"></image>
        <view class="relative-info">
          <view class="relative-header">
            <text class="relative-name">{{item.name}}</text>
            <text class="relative-type">{{item.relationType}}</text>
          </view>
          <text class="relative-breed">{{item.breed}}</text>
          <text class="relative-merchant" wx:if="{{item.isMerchantPet}}">{{item.merchantName}}</text>
          <!-- åµŒå¥—äº²å±å…³ç³» -->
          <view class="nested-relatives" wx:if="{{item.nestedRelations && item.nestedRelations.length > 0}}">
            <block wx:for="{{item.nestedRelations}}" wx:key="index">
              <text class="nested-relation">{{item}}</text>
            </block>
          </view>
        </view>
      </view>
    </block>
  </view>

  <!-- æœåŠ¡è®°å½• -->
  <view class="product-detail-section card" wx:if="{{pet.serviceRecords && pet.serviceRecords.length > 0}}">
    <view class="section-title">æœåŠ¡è®°å½•</view>
    <block wx:for="{{pet.serviceRecords}}" wx:key="id">
      <view class="service-item">
        <view class="service-header">
          <text class="service-name">{{item.serviceName}}</text>
          <text class="service-status {{item.status === 'completed' ? 'completed' : 'pending'}}">
            {{item.status === 'completed' ? 'å·²å®Œæˆ' : 'å¾…æœåŠ¡'}}
          </text>
        </view>
        <text class="service-time">{{item.date}} {{item.time}}</text>
        <text class="service-merchant">{{item.merchantName}}</text>
        <view class="service-evaluation" wx:if="{{item.evaluation}}">
          <view class="evaluation-header">
            <text class="evaluation-label">è¯„ä»·:</text>
            <view class="star-rating">
              <block wx:for="{{[1,2,3,4,5]}}" wx:key="index">
                <text class="{{item <= item.evaluation.rating ? 'star-filled' : 'star-empty'}}">{{item <= item.evaluation.rating ? 'â˜…' : 'â˜†'}}</text>
              </block>
            </view>
          </view>
          <text class="evaluation-content">{{item.evaluation.content}}</text>
        </view>
      </view>
    </block>
  </view>
  
  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar">
    <!-- æ™®é€šç”¨æˆ·æ˜¾ç¤ºæŒ‰é’® -->
    <block wx:if="{{!isMerchant}}">
      <!-- é¢„çº¦çœ‹å® æŒ‰é’® (æ€»æ˜¯æ˜¾ç¤ºï¼Œé™¤éå·²å”®å‡º/ä¸‹æ¶ï¼Œè¿™é‡Œç®€åŒ–ä¸ºæœªä¸‹å®šå¯é¢„çº¦) -->
      <button class="btn btn-default appointment-btn" bindtap="bookAppointment" wx:if="{{!pet.isOrdered}}">
        é¢„çº¦çœ‹å® 
      </button>

      <!-- å® ç‰©æœªè¢«ä¸‹å®šæ—¶æ˜¾ç¤ºä¸‹å®šæŒ‰é’® -->
      <block wx:if="{{!pet.isOrdered}}">
        <button class="btn btn-primary buy-now-btn" bindtap="directOrder">
          ä¸‹å®š
        </button>
      </block>
      <!-- å·²ä¸‹å®šçŠ¶æ€çš„å® ç‰©æ˜¾ç¤ºè”ç³»å•†å®¶æŒ‰é’® -->
      <block wx:if="{{pet.isOrdered}}">
        <button class="btn btn-primary buy-now-btn" bindtap="showContactModal">
          è”ç³»å•†å®¶
        </button>
      </block>
    </block>
    <!-- å•†å®¶ç«¯æ˜¾ç¤ºè°ƒæ•´ä»·æ ¼æŒ‰é’® -->
    <block wx:if="{{isMerchant}}">
      <button class="btn btn-default adjust-price-btn merchant-btn" bindtap="showPriceAdjustModal">
        è°ƒæ•´ä»·æ ¼
      </button>
      <button class="btn btn-primary merchant-btn" bindtap="editPet">
        ç¼–è¾‘
      </button>
    </block>
  </view>

  <!-- æµ®åŠ¨åŠ å…¥è´­ç‰©è½¦æŒ‰é’® -->
  <view class="floating-cart-btn" bindtap="addToCart" wx:if="{{!isMerchant}}">
    <text class="cart-icon">ğŸ›’</text>
    <text>åŠ å…¥è´­ç‰©è½¦</text>
  </view>
  
  <!-- è”ç³»å•†å®¶æ¨¡æ€æ¡† -->
  <view class="modal-mask" wx:if="{{showContactModal}}" bindtap="hideContactModal"></view>
  <view class="contact-modal" wx:if="{{showContactModal}}">
    <view class="modal-header">
      <text class="modal-title">è”ç³»å•†å®¶</text>
      <text class="close-btn" bindtap="hideContactModal">Ã—</text>
    </view>
    <view class="modal-content">
      <!-- å¾®ä¿¡äºŒç»´ç  -->
      <view class="contact-method">
        <text class="method-title">å¾®ä¿¡è”ç³»</text>
        <view class="qrcode-container">
          <image src="{{merchantInfo.wechatQrcode || 'https://via.placeholder.com/200'}}"></image>
          <text class="qrcode-tip">æ‰«æäºŒç»´ç æ·»åŠ å•†å®¶å¾®ä¿¡</text>
        </view>
      </view>
      
      <!-- ç”µè¯å·ç  -->
      <view class="contact-method">
        <text class="method-title">ç”µè¯è”ç³»</text>
        <view class="phone-container">
          <text class="phone-number">{{merchantInfo.phone}}</text>
          <button class="call-btn" bindtap="callMerchant">
            <text class="call-icon">ğŸ“</text>
            <text>æ‹¨æ‰“</text>
          </button>
        </view>
      </view>
    </view>
  </view>
  
  <!-- ä»·æ ¼è°ƒæ•´æ¨¡æ€æ¡† -->
  <view class="modal-mask" wx:if="{{showPriceAdjustModal}}" bindtap="hidePriceAdjustModal"></view>
  <view class="price-adjust-modal" wx:if="{{showPriceAdjustModal}}">
    <view class="modal-header">
      <text class="modal-title">è°ƒæ•´å® ç‰©ä»·æ ¼</text>
      <text class="close-btn" bindtap="hidePriceAdjustModal">Ã—</text>
    </view>
    <view class="modal-content">
      <view class="price-input-section">
        <text class="price-label">å® ç‰©æ€»ä»·</text>
        <view class="price-input-wrapper">
          <text class="price-symbol">Â¥</text>
          <input type="number" placeholder="è¯·è¾“å…¥å® ç‰©æ€»ä»·" value="{{newPrice}}" bindinput="onPriceInputChange" class="price-input" />
        </view>
      </view>
      
      <view class="deposit-info-section">
        <text class="deposit-label">å®šé‡‘è®¡ç®—</text>
        <text class="deposit-formula">å®šé‡‘ = å® ç‰©æ€»ä»· Ã— 30%</text>
        <text class="deposit-preview">é¢„è®¡å®šé‡‘ï¼šÂ¥{{newDeposit}}</text>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-default" bindtap="hidePriceAdjustModal">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="updatePetPrice">ç¡®å®š</button>
    </view>
  </view>
</view>
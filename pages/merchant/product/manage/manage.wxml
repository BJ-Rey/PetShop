<!-- pages/merchant/product/manage/manage.wxml -->
<view class="container">
  <!-- é¡¶éƒ¨æ“ä½œæ  -->
  <view class="standard-action-bar">
    <text class="standard-back-btn" bindtap="navigateBack">â†</text>
    <text class="page-title">å•†å“ç®¡ç†</text>
    <button class="logout-btn" bindtap="logout">é€€å‡ºç™»å½•</button>
  </view>

  <!-- æœç´¢æ  -->
  <view class="search-bar">
    <input 
      class="search-input" 
      placeholder="æœç´¢å•†å“åç§°" 
      bindinput="onSearch"
      value="{{filter.keyword}}"
    />
    <button class="add-btn" type="primary" bindtap="addProduct">+ æ·» åŠ </button>
  </view>

  <!-- ç­›é€‰æ  -->
  <view class="filter-bar">
    <view class="filter-row">
      <!-- çŠ¶æ€ç­›é€‰ -->
      <view class="filter-item collapsed">
        <view class="filter-header" bindtap="toggleFilter" data-type="status">
          <text class="filter-label">çŠ¶æ€ï¼š</text>
          <text class="filter-value">{{filter.status === 'all' ? 'å…¨éƒ¨' : filter.status === 'published' ? 'å·²ä¸Šæ¶' : 'å·²ä¸‹æ¶'}}</text>
          <text class="filter-arrow {{expandedFilter === 'status' ? 'up' : 'down'}}">â–¼</text>
        </view>
        <view class="filter-options" wx:if="{{expandedFilter === 'status'}}">
          <view 
            class="filter-option {{filter.status === 'all' ? 'active' : ''}}" 
            data-type="status" 
            data-value="all"
            bindtap="changeFilter"
          >
            å…¨éƒ¨
          </view>
          <view 
            class="filter-option {{filter.status === 'published' ? 'active' : ''}}" 
            data-type="status" 
            data-value="published"
            bindtap="changeFilter"
          >
            å·²ä¸Šæ¶
          </view>
          <view 
            class="filter-option {{filter.status === 'unpublished' ? 'active' : ''}}" 
            data-type="status" 
            data-value="unpublished"
            bindtap="changeFilter"
          >
            å·²ä¸‹æ¶
          </view>
        </view>
      </view>
      
      <!-- åˆ†ç±»ç­›é€‰ -->
      <view class="filter-item collapsed">
        <view class="filter-header" bindtap="toggleFilter" data-type="category">
          <text class="filter-label">åˆ†ç±»ï¼š</text>
          <text class="filter-value">{{filter.category === 'all' ? 'å…¨éƒ¨' : filter.category === 'food' ? 'é£Ÿå“' : filter.category === 'toy' ? 'ç©å…·' : filter.category === 'medical' ? 'åŒ»ç–—' : 'ç”¨å“'}}</text>
          <text class="filter-arrow {{expandedFilter === 'category' ? 'up' : 'down'}}">â–¼</text>
        </view>
        <view class="filter-options" wx:if="{{expandedFilter === 'category'}}">
          <view 
            class="filter-option {{filter.category === 'all' ? 'active' : ''}}" 
            data-type="category" 
            data-value="all"
            bindtap="changeFilter"
          >
            å…¨éƒ¨
          </view>
          <view 
            class="filter-option {{filter.category === 'food' ? 'active' : ''}}" 
            data-type="category" 
            data-value="food"
            bindtap="changeFilter"
          >
            é£Ÿå“
          </view>
          <view 
            class="filter-option {{filter.category === 'toy' ? 'active' : ''}}" 
            data-type="category" 
            data-value="toy"
            bindtap="changeFilter"
          >
            ç©å…·
          </view>
          <view 
            class="filter-option {{filter.category === 'medical' ? 'active' : ''}}" 
            data-type="category" 
            data-value="medical"
            bindtap="changeFilter"
          >
            åŒ»ç–—
          </view>
          <view 
            class="filter-option {{filter.category === 'accessory' ? 'active' : ''}}" 
            data-type="category" 
            data-value="accessory"
            bindtap="changeFilter"
          >
            ç”¨å“
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ’åºæ  -->
  <view class="sort-bar">
    <view 
      class="sort-item {{sortField === 'createdAt' ? 'active' : ''}}" 
      data-field="createdAt"
      bindtap="changeSort"
    >
      <text>åˆ›å»ºæ—¶é—´</text>
      <text class="sort-icon">{{sortField === 'createdAt' ? (sortOrder === 'desc' ? 'â†“' : 'â†‘') : ''}}</text>
    </view>
    <view 
      class="sort-item {{sortField === 'sales' ? 'active' : ''}}" 
      data-field="sales"
      bindtap="changeSort"
    >
      <text>é”€é‡</text>
      <text class="sort-icon">{{sortField === 'sales' ? (sortOrder === 'desc' ? 'â†“' : 'â†‘') : ''}}</text>
    </view>
    <view 
      class="sort-item {{sortField === 'price' ? 'active' : ''}}" 
      data-field="price"
      bindtap="changeSort"
    >
      <text>ä»·æ ¼</text>
      <text class="sort-icon">{{sortField === 'price' ? (sortOrder === 'desc' ? 'â†“' : 'â†‘') : ''}}</text>
    </view>
  </view>

  <!-- æ‰¹é‡æ“ä½œæ  -->
  <view class="batch-action-bar" wx:if="{{products.length > 0}}">
    <view class="batch-select">
      <checkbox-group bindchange="toggleAllSelect">
        <label class="checkbox-label">
          <checkbox value="all" checked="{{isAllSelected}}" />
          <text>å…¨é€‰</text>
        </label>
      </checkbox-group>
      <text class="selected-count" wx:if="{{selectedProductIds.length > 0}}">({{selectedProductIds.length}} é¡¹)</text>
    </view>
    <view class="batch-buttons">
      <!-- åŸºç¡€æ‰¹é‡æ“ä½œæŒ‰é’® -->
      <button class="batch-btn" bindtap="batchPublish" wx:if="{{selectedProductIds.length > 0}}">æ‰¹é‡ä¸Šæ¶</button>
      <button class="batch-btn" bindtap="batchUnpublish" wx:if="{{selectedProductIds.length > 0}}">æ‰¹é‡ä¸‹æ¶</button>
      <button class="batch-btn delete" bindtap="batchDelete" wx:if="{{selectedProductIds.length > 0}}">æ‰¹é‡åˆ é™¤</button>
      
      <!-- æ›´å¤šæ‰¹é‡æ“ä½œèœå• -->
      <view class="more-actions" wx:if="{{selectedProductIds.length > 0}}">
        <button class="batch-btn more-btn" bindtap="toggleMoreActions">æ›´å¤š</button>
        <view class="more-actions-menu" wx:if="{{showMoreActions}}">
          <view class="more-action-item" bindtap="batchUpdateCategory">æ‰¹é‡æ›´æ–°åˆ†ç±»</view>
          <view class="more-action-item" bindtap="batchUpdatePrice">æ‰¹é‡æ›´æ–°ä»·æ ¼</view>
          <view class="more-action-item" bindtap="batchUpdateStock">æ‰¹é‡æ›´æ–°åº“å­˜</view>
          <view class="more-action-item" bindtap="batchExport">æ‰¹é‡å¯¼å‡º</view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- æ‰¹é‡æ›´æ–°åˆ†ç±»å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showUpdateCategoryModal}}" bindtap="closeUpdateCategoryModal"></view>
  <view class="modal-content" wx:if="{{showUpdateCategoryModal}}">
    <view class="modal-header">
      <text class="modal-title">æ‰¹é‡æ›´æ–°åˆ†ç±»</text>
      <text class="modal-close" bindtap="closeUpdateCategoryModal">Ã—</text>
    </view>
    <view class="modal-body">
      <view class="form-item">
        <text class="form-label">é€‰æ‹©åˆ†ç±»</text>
        <picker 
          class="form-picker" 
          range="{{categories}}" 
          value="{{selectedUpdateCategoryIndex}}"
          bindchange="onUpdateCategoryChange"
        >
          <view class="picker-text">{{selectedUpdateCategory}}</view>
        </picker>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn cancel" bindtap="closeUpdateCategoryModal">å–æ¶ˆ</button>
      <button class="modal-btn confirm" bindtap="confirmBatchUpdateCategory">ç¡®è®¤æ›´æ–°</button>
    </view>
  </view>
  
  <!-- æ‰¹é‡æ›´æ–°ä»·æ ¼å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showUpdatePriceModal}}" bindtap="closeUpdatePriceModal"></view>
  <view class="modal-content" wx:if="{{showUpdatePriceModal}}">
    <view class="modal-header">
      <text class="modal-title">æ‰¹é‡æ›´æ–°ä»·æ ¼</text>
      <text class="modal-close" bindtap="closeUpdatePriceModal">Ã—</text>
    </view>
    <view class="modal-body">
      <view class="form-item">
        <text class="form-label">æ›´æ–°æ–¹å¼</text>
        <radio-group class="radio-group" bindchange="onPriceUpdateTypeChange" value="{{priceUpdateType}}">
          <label class="radio-item">
            <radio value="percentage" />æŒ‰ç™¾åˆ†æ¯”
          </label>
          <label class="radio-item">
            <radio value="fixed" />æŒ‰å›ºå®šé‡‘é¢
          </label>
        </radio-group>
      </view>
      <view class="form-item">
        <text class="form-label">æ›´æ–°å€¼</text>
        <input 
          class="form-input" 
          placeholder="è¯·è¾“å…¥æ›´æ–°å€¼" 
          type="digit"
          value="{{priceUpdateValue}}"
          bindinput="onPriceUpdateValueInput"
        />
        <text class="input-tip">{{priceUpdateType === 'percentage' ? '(ä¾‹å¦‚ï¼š10è¡¨ç¤º+10%ï¼Œ-10è¡¨ç¤º-10%)' : '(ä¾‹å¦‚ï¼š10è¡¨ç¤º+10å…ƒï¼Œ-10è¡¨ç¤º-10å…ƒ)'}}</text>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn cancel" bindtap="closeUpdatePriceModal">å–æ¶ˆ</button>
      <button class="modal-btn confirm" bindtap="confirmBatchUpdatePrice">ç¡®è®¤æ›´æ–°</button>
    </view>
  </view>
  
  <!-- æ‰¹é‡æ›´æ–°åº“å­˜å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showUpdateStockModal}}" bindtap="closeUpdateStockModal"></view>
  <view class="modal-content" wx:if="{{showUpdateStockModal}}">
    <view class="modal-header">
      <text class="modal-title">æ‰¹é‡æ›´æ–°åº“å­˜</text>
      <text class="modal-close" bindtap="closeUpdateStockModal">Ã—</text>
    </view>
    <view class="modal-body">
      <view class="form-item">
        <text class="form-label">æ›´æ–°æ–¹å¼</text>
        <radio-group class="radio-group" bindchange="onStockUpdateTypeChange" value="{{stockUpdateType}}">
          <label class="radio-item">
            <radio value="set" />è®¾ç½®ä¸ºå›ºå®šå€¼
          </label>
          <label class="radio-item">
            <radio value="add" />å¢åŠ 
          </label>
          <label class="radio-item">
            <radio value="reduce" />å‡å°‘
          </label>
        </radio-group>
      </view>
      <view class="form-item">
        <text class="form-label">æ›´æ–°å€¼</text>
        <input 
          class="form-input" 
          placeholder="è¯·è¾“å…¥æ›´æ–°å€¼" 
          type="number"
          value="{{stockUpdateValue}}"
          bindinput="onStockUpdateValueInput"
        />
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn cancel" bindtap="closeUpdateStockModal">å–æ¶ˆ</button>
      <button class="modal-btn confirm" bindtap="confirmBatchUpdateStock">ç¡®è®¤æ›´æ–°</button>
    </view>
  </view>

  <!-- å•†å“åˆ—è¡¨ -->
  <view class="product-list">
    <view class="empty-state" wx:if="{{!isLoading && products.length === 0}}">
      <text class="empty-icon">ğŸ“¦</text>
      <text class="empty-text">æš‚æ— å•†å“æ•°æ®</text>
      <button class="empty-btn" type="primary" bindtap="addProduct">æ·»åŠ å•†å“</button>
    </view>
    
    <view class="loading-state" wx:if="{{isLoading}}">
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
    
    <block wx:else>
      <view class="product-item card" wx:for="{{products}}" wx:key="id">
        <checkbox-group bindchange="toggleSelect" data-id="{{item.id}}">
          <label class="checkbox-label">
            <checkbox value="{{item.id}}" checked="{{selectedProductIds.indexOf(item.id) > -1}}" />
          </label>
        </checkbox-group>
        <image class="product-image" src="{{item.image}}"></image>
        
        <view class="product-info">
          <text class="product-name">{{item.name}}</text>
          <text class="product-category">{{item.category === 'food' ? 'é£Ÿå“' : item.category === 'toy' ? 'ç©å…·' : item.category === 'medical' ? 'åŒ»ç–—' : item.category === 'accessory' ? 'ç”¨å“' : 'å…¶ä»–'}}</text>
          
          <view class="product-price">
            <text class="current-price">Â¥{{item.price}}</text>
            <text class="original-price">Â¥{{item.originalPrice}}</text>
          </view>
          
          <view class="product-meta">
            <text class="product-stock">åº“å­˜ï¼š{{item.stock}}</text>
            <text class="product-sales">é”€é‡ï¼š{{item.sales}}</text>
          </view>
        </view>
        
        <view class="product-status">
          <text class="status-tag {{item.status === 'published' ? 'published' : 'unpublished'}}">
            {{item.status === 'published' ? 'å·²ä¸Šæ¶' : 'å·²ä¸‹æ¶'}}
          </text>
        </view>
        
        <view class="product-actions">
          <button 
            class="action-btn edit-btn" 
            bindtap="editProduct" 
            data-id="{{item.id}}"
          >
            ç¼–è¾‘
          </button>
          <button 
            class="action-btn {{item.status === 'published' ? 'unpublish-btn' : 'publish-btn'}}" 
            bindtap="toggleProductStatus" 
            data-id="{{item.id}}"
          >
            {{item.status === 'published' ? 'ä¸‹æ¶' : 'ä¸Šæ¶'}}
          </button>
          <button 
            class="action-btn delete-btn" 
            bindtap="deleteProduct" 
            data-id="{{item.id}}" 
            data-name="{{item.name}}"
          >
            åˆ é™¤
          </button>
        </view>
      </view>
    </block>
  </view>
</view>